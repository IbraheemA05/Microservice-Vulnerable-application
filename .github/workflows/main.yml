name: Microservices-Vulnerable CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-secure:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
    # ------------------------
    # CHECKOUT CODE
    # ------------------------
    - name: Checkout Code
      uses: actions/checkout@v4

    # ------------------------
    # SETUP NODE
    # ------------------------
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22

    # ------------------------
    # SETUP SNYK CLI
    # ------------------------
    - name: Setup Snyk
      uses: snyk/actions/setup@master
    
    #-------------------------
    # SETUP SYFT CLI
    #-------------------------
    - name: Setup Syft
      uses: anchore/sbom-action@v0.16.0

    # ------------------------
    # SAST (Code Analysis)
    # ------------------------
    - name: Run Snyk SAST (Auth & Settings)
      run: |
        cd auth && snyk code test --severity-threshold=high
        cd ../settings && snyk code test --severity-threshold=high
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    # ------------------------
    # SCA (Dependency Scan)
    # ------------------------
    - name: Run Snyk SCA
      run: |
        cd auth && snyk test --severity-threshold=high
        cd ../settings && snyk test --severity-threshold=high
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    # ------------------------
    # LOGIN TO DOCKER
    # ------------------------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ------------------------
    # BUILD IMAGES
    # ------------------------
    - name: Build Docker Images
      run: |
        docker build -t auth-service:${{ github.sha }} ./auth
        docker build -t settings-service:${{ github.sha }} ./settings

    # ------------------------
    # CONTAINER SCANNING
    # ------------------------
    - name: Snyk Container Scan
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        snyk container test auth-service:${{ github.sha }} --severity-threshold=high
        snyk container test settings-service:${{ github.sha }} --severity-threshold=high

    # ------------------------
    # MONITOR (DASHBOARD)
    # ------------------------
    - name: Send Results to Snyk Dashboard
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        snyk monitor --project-name=auth-service
        snyk monitor --project-name=settings-service
    
    #------------------------
    # GENERATE SBOM WITH SYFT
    #------------------------
    - name: Generate SBOM with Syft
      run: |
        syft auth-service:${{ github.sha }} \
          -o cyclonedx-json=auth-service.sbom.json

        syft settings-service:${{ github.sha }} \
          -o cyclonedx-json=settings-service.sbom.json

    #------------------------
    # UPLOAD SBOM TO SNYK
    #------------------------
    - name: Upload SBOM to Snyk
      if: always()
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        snyk sbom test \
        --file=auth-service.sbom.json \
        --project-name=auth-service

        snyk sbom test \
        --file=settings-service.sbom.json \
        --project-name=settings-service

    - name: Upload SBOM artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sbom-${{ github.sha }}
        path: |
          auth-service.sbom.json
          settings-service.sbom.json
